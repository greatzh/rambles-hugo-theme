{{ define "main" }}
<div class="homepage-content">{{ .Content }}</div>

<div class="articles h-feed post-single">
  {{ $pages := where .Site.RegularPages "Section" "not in" (slice "about"
  "posts" "all" "today") }} {{ $pages = where $pages "Params.hidden" "!=" true
  }} {{ $pagesByYear := $pages.GroupByDate "2006" }}
  <h1>Archive</h1>

  <!-- GitHub 风格的贡献图表 -->
  <div class="github-style-contribution">
    <div class="contribution-header">
      <div>
        <h2>碎碎念热力图</h2>
        <div id="contribution-summary" class="contribution-summary"></div>
      </div>
      <div class="year-selector-container">
        <select id="year-selector" class="year-selector">
          <option value="last365">过去一年</option>
          {{ range $pagesByYear }}
          <option value="{{ .Key }}">{{ .Key }}年</option>
          {{ end }}
        </select>
      </div>
    </div>

    <div class="contribution-graph-container">
      <div class="contribution-graph-scroll">
        <div id="contribution-graph" class="contribution-graph"></div>
      </div>
    </div>

    <div class="contribution-legend">
      <span>少</span>
      <ul class="contribution-legend-squares">
        <li
          class="contribution-legend-square"
          style="background-color: var(--theme-color-level0)"
        ></li>
        <li
          class="contribution-legend-square"
          style="background-color: var(--theme-color-level1)"
        ></li>
        <li
          class="contribution-legend-square"
          style="background-color: var(--theme-color-level2)"
        ></li>
        <li
          class="contribution-legend-square"
          style="background-color: var(--theme-color-level3)"
        ></li>
        <li
          class="contribution-legend-square"
          style="background-color: var(--theme-color-level4)"
        ></li>
      </ul>
      <span>多</span>
    </div>

    <!-- 日期详情区域 - 直接显示在热力图下方 -->
    <div id="day-details" class="day-details" style="display: none">
      <div class="day-details-header">
        <span id="day-details-count"></span>
        <span id="day-details-date"></span>
        <span class="day-details-close" onclick="closeDayDetails()">×</span>
      </div>
      <div id="day-details-content" class="day-details-content"></div>
    </div>
  </div>

  <!-- 使用Hugo生成的JSON数据 -->
  <script id="contribution-data" type="application/json">
    {
      {{ range $yearIndex, $yearGroup := $pagesByYear }}
      "{{ $yearGroup.Key }}": {
        {{ $year := $yearGroup.Key }}
        {{ $dateMap := dict }}
        {{ range $yearGroup.Pages }}
          {{ $dateStr := .Date.Format "2006-01-02" }}
          {{ $existingData := index $dateMap $dateStr | default dict }}
          {{ $existingCount := index $existingData "count" | default 0 }}
          {{ $existingPosts := index $existingData "posts" | default slice }}
          {{ $newPost := dict "title" .Title "url" .Permalink "remark" (default "" .Params.remark) }}
          {{ $newPosts := $existingPosts | append $newPost }}
          {{ $newData := dict "count" (add $existingCount 1) "posts" $newPosts }}
          {{ $dateMap = merge $dateMap (dict $dateStr $newData) }}
        {{ end }}
        {{ $comma := false }}
        {{ range $date, $data := $dateMap }}
          {{ if $comma }},{{ end }}
          "{{ $date }}": {
            "count": {{ $data.count }},
            "posts": [
              {{ range $postIndex, $post := $data.posts }}
              {{ if $postIndex }},{{ end }}
              {
                "title": {{ $post.title | jsonify }},
                "url": {{ $post.url | jsonify }},
                "remark": {{ $post.remark | jsonify }}
              }
              {{ end }}
            ]
          }
          {{ $comma = true }}
        {{ end }}
      }{{ if ne $yearIndex (sub (len $pagesByYear) 1) }},{{ end }}
      {{ end }}
    }
  </script>
</div>

<script>
  // GitHub 风格贡献图表的脚本
  document.addEventListener("DOMContentLoaded", function () {
    // 从Hugo生成的JSON数据中获取数据
    const contributionDataElement =
      document.getElementById("contribution-data");
    const contributionData = JSON.parse(contributionDataElement.textContent);

    // 初始化年份选择器
    const yearSelector = document.getElementById("year-selector");
    yearSelector.addEventListener("change", function () {
      renderContributionGraph(this.value);
      updateContributionSummary(this.value);
    });

    // 更新年度统计信息
    function updateContributionSummary(year) {
      const summaryElement = document.getElementById("contribution-summary");

      // 计算该年度的总碎碎念数量
      let totalCount = 0;

      if (year === "last365") {
        // 计算过去365天的总碎碎念数量
        const today = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setDate(today.getDate() - 365);

        // 遍历所有年份的数据
        Object.keys(contributionData).forEach((yearKey) => {
          Object.keys(contributionData[yearKey]).forEach((dateStr) => {
            const date = new Date(dateStr);
            if (date >= oneYearAgo && date <= today) {
              totalCount += contributionData[yearKey][dateStr].count;
            }
          });
        });

        // 更新显示
        summaryElement.textContent = `过去一年有 ${totalCount} 条碎碎念`;
      } else {
        // 计算特定年份的总碎碎念数量
        if (contributionData[year]) {
          Object.values(contributionData[year]).forEach((dayData) => {
            totalCount += dayData.count;
          });
        }

        // 更新显示
        summaryElement.textContent = `${year}年 有 ${totalCount} 条碎碎念`;
      }
    }

    // 渲染贡献图
    function renderContributionGraph(year) {
      const graphContainer = document.getElementById("contribution-graph");
      graphContainer.innerHTML = "";

      // 创建星期标签和日期单元格
      const weekdays = ["Sun", "Mon", "", "Wed", "", "Fri", ""];

      // 创建月份标签行
      const monthsRow = document.createElement("div");
      monthsRow.className = "months-row";

      // 添加空白单元格（对应星期标签列）
      const emptyCell = document.createElement("div");
      emptyCell.className = "month-label empty";
      monthsRow.appendChild(emptyCell);

      // 先添加到容器中
      graphContainer.appendChild(monthsRow);

      // 创建日期单元格行
      const rows = [];
      for (let weekday = 0; weekday < 7; weekday++) {
        const row = document.createElement("div");
        row.className = "contribution-row";

        // 添加星期标签
        const weekdayLabel = document.createElement("div");
        weekdayLabel.className = "weekday-label";
        weekdayLabel.textContent = weekdays[weekday];
        row.appendChild(weekdayLabel);

        rows.push(row);
        graphContainer.appendChild(row);
      }

      let firstDayOfYear, lastDayOfYear, totalWeeks;

      if (year === "last365") {
        // 过去一年的日期范围
        lastDayOfYear = new Date(); // 今天
        firstDayOfYear = new Date();
        firstDayOfYear.setDate(lastDayOfYear.getDate() - 365); // 365天前
      } else {
        // 特定年份的日期范围
        firstDayOfYear = new Date(`${year}-01-01`);
        lastDayOfYear = new Date(`${year}-12-31`);
      }

      // 计算第一天是星期几
      const firstDayWeekday = firstDayOfYear.getDay(); // 0 = 周日, 1 = 周一, ...

      // 计算总天数和总周数
      const totalDays =
        (lastDayOfYear - firstDayOfYear) / (24 * 60 * 60 * 1000) + 1;
      totalWeeks = Math.ceil((totalDays + firstDayWeekday) / 7);

      // 为每个月添加日期单元格
      const months = [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "May",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec",
      ];
      const monthFirstWeek = {}; // 记录每个月第一天所在的周

      // 创建一个二维数组来存储每个位置的单元格
      const cellGrid = Array(7)
        .fill()
        .map(() => Array(totalWeeks).fill(null));

      // 填充单元格
      let currentDate = new Date(firstDayOfYear);
      const endDate = new Date(lastDayOfYear);

      while (currentDate <= endDate) {
        const month = currentDate.getMonth() + 1; // 1-12
        const day = currentDate.getDate();
        const weekday = currentDate.getDay(); // 0-6
        const currentYear = currentDate.getFullYear().toString();

        // 计算当前日期是第几周
        const dayOfYear =
          Math.floor((currentDate - firstDayOfYear) / (24 * 60 * 60 * 1000)) +
          1;
        const weekOfYear = Math.floor((dayOfYear + firstDayWeekday - 1) / 7);

        // 如果是每月第一天，记录其所在的周
        if (day === 1) {
          monthFirstWeek[`${currentYear}-${month}`] = weekOfYear;
        }

        // 创建单元格
        const dateStr = currentDate.toISOString().split("T")[0]; // YYYY-MM-DD
        const yearOfDate = dateStr.substring(0, 4);
        const dayData =
          contributionData[yearOfDate] && contributionData[yearOfDate][dateStr];
        const count = dayData ? dayData.count : 0;

        const cell = document.createElement("div");
        cell.className = "contribution-cell";
        cell.dataset.date = dateStr;
        cell.dataset.count = count;

        // 根据文章数量设置颜色级别
        let colorLevel = 0;
        if (count > 0) {
          if (count <= 1) colorLevel = 1;
          else if (count <= 3) colorLevel = 2;
          else if (count <= 5) colorLevel = 3;
          else colorLevel = 4;
        }

        cell.classList.add(`level-${colorLevel}`);
        cell.style.backgroundColor = `var(--theme-color-level${colorLevel})`;

        // 添加点击事件
        if (count > 0) {
          cell.addEventListener("click", function () {
            showDayDetails(dateStr, count, dayData.posts);
          });
        }

        // 添加提示
        cell.title = `${dateStr}: ${count} 篇碎碎念`;

        // 将单元格存储到网格中
        cellGrid[weekday][weekOfYear] = cell;

        // 移动到下一天
        currentDate.setDate(currentDate.getDate() + 1);
      }

      // 将单元格添加到行中
      for (let weekday = 0; weekday < 7; weekday++) {
        // 创建月份容器
        const monthContainer = document.createElement("div");
        monthContainer.className = "month-container";
        rows[weekday].appendChild(monthContainer);

        for (let week = 0; week < totalWeeks; week++) {
          const cell = cellGrid[weekday][week];
          if (cell) {
            monthContainer.appendChild(cell);
          } else {
            // 如果没有单元格，添加一个空白单元格保持对齐
            const emptyCell = document.createElement("div");
            emptyCell.className = "contribution-cell empty";
            monthContainer.appendChild(emptyCell);
          }
        }
      }

      // 添加月份标签
      // 如果是过去一年，需要显示跨年的月份标签
      const monthsToShow = new Set();
      let currentMonthDate = new Date(firstDayOfYear);
      while (currentMonthDate <= endDate) {
        const monthYear = `${currentMonthDate.getFullYear()}-${
          currentMonthDate.getMonth() + 1
        }`;
        monthsToShow.add(monthYear);
        // 移动到下个月
        currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
      }

      // 添加月份标签
      monthsToShow.forEach((monthYear) => {
        const [yearStr, monthNum] = monthYear.split("-").map(Number);
        if (monthFirstWeek[monthYear] !== undefined) {
          const monthLabel = document.createElement("div");
          monthLabel.className = "month-label";
          monthLabel.textContent = months[monthNum - 1];
          monthLabel.dataset.month = monthYear;

          // 计算月份标签的位置
          const weekPosition = monthFirstWeek[monthYear];

          // 设置月份标签的位置
          const cellWidth = 18; // 移动设备上单元格宽度更小
          const labelOffset = 35; // 移动设备上标签偏移更小
          monthLabel.style.left = `${weekPosition * cellWidth + labelOffset}px`;

          // 将月份标签添加到月份行
          monthsRow.appendChild(monthLabel);
        }
      });

      // 添加窗口大小变化监听器，调整月份标签位置
      window.addEventListener("resize", function () {
        const monthLabels = document.querySelectorAll(
          ".month-label[data-month]"
        );
        monthLabels.forEach((label) => {
          const monthYear = label.dataset.month;
          const weekPosition = monthFirstWeek[monthYear];
          if (weekPosition !== undefined) {
            const cellWidth = 18;
            const labelOffset = 35;
            label.style.left = `${weekPosition * cellWidth + labelOffset}px`;
          }
        });
      });
    }

    // 获取某月的天数
    function getDaysInMonth(year, month) {
      if (month === 4 || month === 6 || month === 9 || month === 11) {
        return 30;
      } else if (month === 2) {
        // 闰年判断
        return (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0
          ? 29
          : 28;
      } else {
        return 31;
      }
    }

    // 显示某天的详细信息
    function showDayDetails(dateStr, count, posts) {
      const dayDetails = document.getElementById("day-details");
      const dayDetailsDate = document.getElementById("day-details-date");
      const dayDetailsCount = document.getElementById("day-details-count");
      const dayDetailsContent = document.getElementById("day-details-content");

      // 设置日期和文章数量
      const date = new Date(dateStr);
      const formattedDate = `${date.getFullYear()}-${
        date.getMonth() + 1
      }-${date.getDate()}`;
      dayDetailsDate.textContent = formattedDate;
      dayDetailsCount.textContent = `${count} 条碎碎念`;

      // 清空并填充内容
      dayDetailsContent.innerHTML = "";
      posts.forEach((post) => {
        const postElement = document.createElement("div");
        postElement.className = "day-details-post";

        const postLink = document.createElement("a");
        postLink.href = post.url;
        // 去除标题中的双引号
        const cleanTitle = post.title.replace(/^"|"$/g, "");
        postLink.textContent = `#${cleanTitle}`;
        if (post.remark) {
          // 去除备注中的双引号
          const cleanRemark = post.remark.replace(/^"|"$/g, "");
          postLink.textContent += ` ${cleanRemark}`;
        }

        postElement.appendChild(postLink);
        dayDetailsContent.appendChild(postElement);
      });

      // 显示详情面板（直接在页面上显示，不是弹窗）
      dayDetails.style.display = "block";

      // 滚动到详情面板
      dayDetails.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    // 关闭详情面板
    window.closeDayDetails = function () {
      document.getElementById("day-details").style.display = "none";
    };

    // 初始渲染最新年份的贡献图
    if (yearSelector.options.length > 0) {
      // 默认选择"过去一年"选项
      const initialYear = "last365";
      renderContributionGraph(initialYear);
      updateContributionSummary(initialYear);
    }
  });
</script>

<style>
  /* GitHub 风格贡献图表的样式 */

  .github-style-contribution {
    margin: 2rem 0;
    padding: 1rem;
    border-radius: 8px;
  }

  .contribution-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .contribution-summary {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
  }

  .year-selector {
    padding: 0.5rem;
    border-radius: 4px;
    border: 1px solid var(--border-color);
    background-color: var(--background-color);
    color: var(--text-primary);
    font-size: 1rem;
    cursor: pointer;
    appearance: auto; /* 保持原生下拉样式 */
  }

  /* 修复下拉选项在黑暗模式下的颜色问题 */
  .year-selector option {
    background-color: var(--background-color);
    color: var(--text-primary);
  }

  .contribution-graph-container {
    position: relative;
    margin-bottom: 1rem;
  }

  .contribution-graph-scroll {
    overflow-x: auto;
    padding-bottom: 0.5rem;
    /* 自定义滚动条样式 */
    scrollbar-width: thin; /* Firefox */
    scrollbar-color: var(--border-color) var(--background-light); /* Firefox */
  }

  /* Webkit浏览器的滚动条样式 */
  .contribution-graph-scroll::-webkit-scrollbar {
    height: 8px;
  }

  .contribution-graph-scroll::-webkit-scrollbar-track {
    background: var(--background-light);
    border-radius: 4px;
  }

  .contribution-graph-scroll::-webkit-scrollbar-thumb {
    background-color: var(--border-color);
    border-radius: 4px;
  }

  .contribution-graph {
    display: flex;
    flex-direction: column;
    min-width: 100%;
  }

  .months-row {
    display: grid;
    grid-template-columns: 30px repeat(53, 18px); /* 30px为星期标签宽度，18px为单元格宽度+间距 */
    margin-bottom: 0.5rem;
    position: relative;
    height: 20px;
  }

  .month-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    position: absolute;
    text-align: left;
    white-space: nowrap;
  }

  .month-label.empty {
    width: 30px;
    position: static;
  }

  .contribution-row {
    display: flex;
    height: 15px;
    margin-bottom: 3px;
  }

  .weekday-label {
    width: 30px;
    font-size: 0.75rem;
    color: var(--text-secondary);
    text-align: right;
    padding-right: 5px;
    flex: none;
  }

  .month-container {
    display: flex;
    flex: 1;
  }

  .contribution-cell {
    width: 15px;
    height: 15px;
    margin-right: 3px;
    border-radius: 2px;
    cursor: pointer;
    transition: transform 0.1s ease;
  }

  .contribution-cell.empty {
    background-color: transparent !important;
    cursor: default;
  }

  .contribution-cell:not(.empty):hover {
    transform: scale(1.2);
    transition: transform 0.1s ease;
  }

  .contribution-legend {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-secondary);
  }

  .contribution-legend-squares {
    display: flex;
    margin: 0 0.5rem;
    padding: 0;
    list-style: none;
  }

  .contribution-legend-square {
    width: 15px;
    height: 15px;
    margin-right: 3px;
    border-radius: 2px;
  }

  .day-details {
    margin-top: 1rem;
  }

  .day-details-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
  }

  .day-details-close {
    cursor: pointer;
    font-size: 1.5rem;
    line-height: 1;
  }

  .day-details-content {
    max-height: 300px;
    overflow-y: auto;
    padding: 1rem;
  }

  .day-details-post {
    margin-bottom: 0.5rem;
  }

  .day-details-post a {
    color: var(--text-primary);
    text-decoration: none;
    border-bottom: none;
  }

  .day-details-post a:hover {
    color: var(--theme-color);
  }

  /* 响应式样式 */
  @media (max-width: 840px) {
    .contribution-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .year-selector-container {
      margin-top: 0.5rem;
      width: 100%;
    }

    .year-selector {
      width: 100%;
    }
  }
</style>

{{ end }}
